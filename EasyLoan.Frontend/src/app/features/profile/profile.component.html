<div class="profile-container">
    <div class="page-header">
        <h2>My Profile</h2>
        <p class="subtitle">View and manage your personal information</p>
    </div>

    @if (isLoading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading your profile...</p>
    </div>
    } @else if (errorMessage() && !profile()) {
    <div class="error-state">
        <p class="error-message">{{ errorMessage() }}</p>
        <button class="retry-btn" (click)="loadProfile()">Retry</button>
    </div>
    } @else if (profile()) {
    <div class="profile-content">
        @if (successMessage()) {
        <div class="success-banner">
            {{ successMessage() }}
        </div>
        }

        @if (errorMessage()) {
        <div class="error-banner">
            {{ errorMessage() }}
        </div>
        }

        <div class="profile-card">
            <div class="card-header">
                <div class="avatar-large">{{ profile()!.name[0]?.toUpperCase() || 'U' }}</div>
                <div class="header-info">
                    <h3>{{ profile()!.name }}</h3>
                    <p class="email">{{ profile()!.email }}</p>
                </div>
                @if (!isEditing()) {
                <button class="edit-btn" (click)="onEdit()">Edit Profile</button>
                }
            </div>

            <div class="card-body">
                @if (!isEditing()) {
                <!-- View Mode -->
                <div class="info-grid">
                    @if (isCustomer()) {
                    <div class="info-item">
                        <span class="label">Date of Birth</span>
                        <span class="value">{{ getCustomerDateOfBirth() }}</span>
                    </div>
                    }
                    <div class="info-item">
                        <span class="label">Phone Number</span>
                        <span class="value">{{ profile()!.phoneNumber }}</span>
                    </div>
                    @if (isCustomer()) {
                    <div class="info-item">
                        <span class="label">Annual Salary</span>
                        <span class="value">₹{{ getCustomerAnnualSalary() | number:'1.2-2' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">PAN Number</span>
                        <span class="value">{{ getCustomerPanNumber() }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Credit Score</span>
                        <span class="value credit-score">{{ getCustomerCreditScore() }}</span>
                    </div>
                    }
                    @if (isEmployee()) {
                    <div class="info-item">
                        <span class="label">Role</span>
                        <span class="value">{{ getEmployeeRole() }}</span>
                    </div>
                    }
                </div>
                } @else {
                <!-- Edit Mode -->
                <form [formGroup]="profileForm" (ngSubmit)="onSave()">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Name *</label>
                            <input type="text" id="name" formControlName="name" maxlength="100"
                                [class.invalid]="profileForm.get('name')?.invalid && profileForm.get('name')?.touched" />
                            @if (profileForm.get('name')?.hasError('required') && profileForm.get('name')?.touched) {
                            <span class="error-text">Name is required</span>
                            }
                            @if (profileForm.get('name')?.hasError('maxlength') && profileForm.get('name')?.touched) {
                            <span class="error-text">Name cannot exceed 100 characters</span>
                            }
                        </div>

                        <div class="form-group">
                            <label for="phoneNumber">Phone Number *</label>
                            <input type="tel" id="phoneNumber" formControlName="phoneNumber"
                                placeholder="10-digit Indian number" maxlength="10"
                                (keydown)="onPhoneNumberKeyDown($event)"
                                [class.invalid]="profileForm.get('phoneNumber')?.invalid && profileForm.get('phoneNumber')?.touched" />
                            @if (profileForm.get('phoneNumber')?.hasError('required') &&
                            profileForm.get('phoneNumber')?.touched) {
                            <span class="error-text">Phone number is required</span>
                            }
                            @if (profileForm.get('phoneNumber')?.hasError('pattern') &&
                            profileForm.get('phoneNumber')?.touched) {
                            <span class="error-text">Phone number must be a valid 10-digit Indian number starting with
                                6-9</span>
                            }
                        </div>

                        @if (isCustomer()) {
                        <div class="form-group">
                            <label for="annualSalary">Annual Salary (₹) *</label>
                            <input type="number" id="annualSalary" formControlName="annualSalary"
                                placeholder="Enter annual salary in rupees" (keydown)="onSalaryKeyDown($event)"
                                [class.invalid]="profileForm.get('annualSalary')?.invalid && profileForm.get('annualSalary')?.touched" />
                            @if (profileForm.get('annualSalary')?.hasError('required') &&
                            profileForm.get('annualSalary')?.touched) {
                            <span class="error-text">Annual salary is required</span>
                            }
                            @if (profileForm.get('annualSalary')?.hasError('min') &&
                            profileForm.get('annualSalary')?.touched) {
                            <span class="error-text">Annual salary must be a positive number</span>
                            }
                            @if (profileForm.get('annualSalary')?.hasError('max') &&
                            profileForm.get('annualSalary')?.touched) {
                            <span class="error-text">Annual salary cannot exceed ₹1000 trillion</span>
                            }
                            @if (profileForm.get('annualSalary')?.hasError('decimalPlaces') &&
                            profileForm.get('annualSalary')?.touched) {
                            <span class="error-text">Annual salary can have maximum 2 decimal places</span>
                            }
                        </div>
                        }
                    </div>

                    <div class="readonly-info">
                        <p class="info-note">
                            @if (isCustomer()) {
                            <strong>Note:</strong> Email, Date of Birth, PAN Number, and Credit Score cannot be
                            modified.
                            } @else {
                            <strong>Note:</strong> Email and Role cannot be modified.
                            }
                        </p>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="cancel-btn" (click)="onCancel()" [disabled]="isSaving()">
                            Cancel
                        </button>
                        <button type="submit" class="save-btn" [disabled]="isSaving() || profileForm.invalid">
                            @if (isSaving()) {
                            <span class="spinner-small"></span>
                            Saving...
                            } @else {
                            Save Changes
                            }
                        </button>
                    </div>
                </form>
                }
            </div>
        </div>
    </div>
    }
</div>