<div class="page-container" *ngIf="!isLoading() && details(); else loading">
    <div class="header-section">
        <button mat-button (click)="goBack()">
            &larr; Back to List
        </button>
        <h1>{{ isManager ? 'Review' : 'View' }} Application: {{details()!.applicationNumber}}</h1>
    </div>

    <div class="content-grid">
        <!-- Customer Details -->
        <mat-card class="detail-card">
            <mat-card-header>
                <mat-card-title>Customer Information</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="info-row">
                    <span class="label">Name:</span> <span class="value">{{details()!.customerName}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Phone:</span> <span class="value">{{details()!.phoneNumber}}</span>
                </div>
                <div class="info-row">
                    <span class="label">PAN Number:</span> <span class="value">{{details()!.panNumber}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Date of Birth:</span> <span class="value">{{details()!.dateOfBirth |
                        date:'mediumDate'}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Annual Salary:</span> <span class="value">{{details()!.annualSalaryOfCustomer |
                        currency:'INR'}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Credit Score:</span> <span
                        class="value highlight">{{details()!.creditScore}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Ongoing Loans:</span> <span
                        class="value">{{details()!.totalOngoingLoans}}</span>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Loan Details -->
        <mat-card class="detail-card">
            <mat-card-header>
                <mat-card-title>Loan Application</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="info-row">
                    <span class="label">Loan Type:</span> <span class="value">{{details()!.loanType}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Amount Requested:</span> <span class="value">{{details()!.requestedAmount |
                        currency:'INR'}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Tenure:</span> <span class="value">{{details()!.requestedTenureInMonths}}
                        months</span>
                </div>
                <div class="info-row">
                    <span class="label">Current Status:</span>
                    <span class="value status-badge"
                        [ngClass]="details()!.status.toLowerCase()">{{details()!.status}}</span>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Review Form (Manager only, and only if pending) -->
        <mat-card class="review-card" *ngIf="isManager && isPending()">
            <mat-card-header>
                <mat-card-title>Review Application</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Decision</mat-label>
                        <mat-select formControlName="status">
                            <mat-option *ngFor="let status of statuses" [value]="status.value">
                                {{status.label}}
                            </mat-option>
                        </mat-select>
                        <mat-error *ngIf="reviewForm.get('status')?.hasError('required')">Status is required</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Approved Amount</mat-label>
                        <input matInput type="number" formControlName="approvedAmount"
                            placeholder="Enter approved amount" step="0.01" [max]="details()!.requestedAmount"
                            (keydown)="onApprovedAmountKeyDown($event)">
                        <mat-hint>Maximum: {{details()!.requestedAmount | currency:'INR'}}</mat-hint>
                        <mat-error *ngIf="reviewForm.get('approvedAmount')?.hasError('required')">
                            Approved amount is required
                        </mat-error>
                        <mat-error *ngIf="reviewForm.get('approvedAmount')?.hasError('min')">
                            Amount must be at least â‚¹1
                        </mat-error>
                        <mat-error *ngIf="reviewForm.get('approvedAmount')?.hasError('max')">
                            Amount cannot exceed requested amount of {{details()!.requestedAmount | currency:'INR'}}
                        </mat-error>
                        <mat-error *ngIf="reviewForm.get('approvedAmount')?.hasError('decimalPlaces')">
                            Amount can have maximum 2 decimal places
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width remarks-field">
                        <mat-label>Remarks</mat-label>
                        <textarea matInput formControlName="remarks" rows="4" placeholder="Enter remarks..."
                            maxlength="1000"></textarea>
                        <mat-hint align="end">{{reviewForm.get('remarks')?.value?.length || 0}}/1000</mat-hint>
                        <mat-error *ngIf="reviewForm.get('remarks')?.hasError('required')">
                            Remarks are required
                        </mat-error>
                        <mat-error *ngIf="reviewForm.get('remarks')?.hasError('minlength')">
                            Minimum 5 characters required
                        </mat-error>
                        <mat-error *ngIf="reviewForm.get('remarks')?.hasError('maxlength')">
                            Maximum 1000 characters allowed
                        </mat-error>
                    </mat-form-field>

                    <div class="form-actions">
                        <button mat-raised-button color="primary" type="submit"
                            [disabled]="reviewForm.invalid || isLoading()">
                            {{ isLoading() ? 'Submitting...' : 'Submit Review' }}
                        </button>
                    </div>
                </form>
            </mat-card-content>
        </mat-card>

        <!-- Read-only Review Details (if not pending) -->
        <mat-card class="review-card" *ngIf="!isPending() && details()!.status !== 'Pending'">
            <mat-card-header>
                <mat-card-title>Review Outcome</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="info-row">
                    <span class="label">Decision:</span> <span class="value">{{details()!.status}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Approved Amount:</span> <span class="value">{{details()!.approvedAmount |
                        currency:'INR'}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Remarks:</span> <span class="value">{{details()!.managerComments}}</span>
                </div>
            </mat-card-content>
        </mat-card>

    </div>
</div>

<ng-template #loading>
    <div class="loading-container">
        <p>Loading application details...</p>
    </div>
</ng-template>