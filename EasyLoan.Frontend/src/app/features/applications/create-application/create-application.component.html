<div class="create-application-container">
    <div class="page-header">
        <h2>Apply for Loan</h2>
        <p class="subtitle">Fill in the details to apply for a new loan</p>
    </div>

    @if (successMessage()) {
    <mat-card class="success-banner">
        <mat-card-content>
            <div class="success-icon">
                <mat-icon color="primary">check_circle</mat-icon>
            </div>
            <div class="success-content">
                <h3>Success!</h3>
                <p>{{ successMessage() }}</p>
                <p class="redirect-message">Redirecting to applications...</p>
            </div>
        </mat-card-content>
    </mat-card>
    } @else {
    @if (isLoadingLoanTypes()) {
    <div class="loading-state">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading loan types...</p>
    </div>
    } @else if (loanTypes().length === 0) {
    <mat-card class="empty-state">
        <mat-card-content>
            <div class="empty-icon">
                <mat-icon>description</mat-icon>
            </div>
            <h3>No Loan Types Available</h3>
            <p>There are currently no loan types available for application.</p>
        </mat-card-content>
    </mat-card>
    } @else {
    <form [formGroup]="applicationForm" (ngSubmit)="onSubmit()" class="application-form">
        <!-- Loan Type Selection -->
        <mat-card class="form-section">
            <mat-card-header>
                <mat-card-title>Loan Type</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Select Loan Type</mat-label>
                    <mat-icon matPrefix>account_balance</mat-icon>
                    <mat-select formControlName="loanTypeId" (selectionChange)="onLoanTypeChange($event)">
                        <mat-option value="">-- Select a loan type --</mat-option>
                        @for (loanType of loanTypes(); track loanType.id) {
                        <mat-option [value]="loanType.id">{{ loanType.name }}</mat-option>
                        }
                    </mat-select>

                    @if (loanTypeId?.hasError('required')) {
                    <mat-error>
                        Please select a loan type
                    </mat-error>
                    }
                </mat-form-field>

                @if (selectedLoanType()) {
                <div class="loan-type-info">
                    <div class="info-item">
                        <mat-icon>percent</mat-icon>
                        <span class="label">Interest Rate:</span>
                        <span class="value">{{ selectedLoanType()!.interestRate }}%</span>
                    </div>
                    <div class="info-item">
                        <mat-icon>currency_rupee</mat-icon>
                        <span class="label">Minimum Amount:</span>
                        <span class="value">₹{{ selectedLoanType()!.minAmount | number:'1.2-2' }}</span>
                    </div>
                    <div class="info-item">
                        <mat-icon>schedule</mat-icon>
                        <span class="label">Maximum Tenure:</span>
                        <span class="value">{{ selectedLoanType()!.maxTenureInMonths }} months</span>
                    </div>
                </div>
                }
            </mat-card-content>
        </mat-card>

        <!-- Loan Details -->
        <mat-card class="form-section">
            <mat-card-header>
                <mat-card-title>Loan Details</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="form-row">
                    <!-- Requested Amount -->
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Requested Amount (₹)</mat-label>
                        <mat-icon matPrefix>currency_rupee</mat-icon>
                        <input matInput type="number" formControlName="requestedAmount" placeholder="Enter amount"
                            min="0" step="1000" (keydown)="onAmountKeyDown($event)">
                        <mat-hint>Maximum amount: ₹10,00,000 (10 lakhs)</mat-hint>

                        @if (requestedAmount?.hasError('required')) {
                        <mat-error>
                            Amount is required
                        </mat-error>
                        }
                        @if (requestedAmount?.hasError('min')) {
                        <mat-error>
                            Amount must be at least ₹{{ selectedLoanType()?.minAmount || 1 | number:'1.2-2' }}
                        </mat-error>
                        }
                        @if (requestedAmount?.hasError('max')) {
                        <mat-error>
                            Amount cannot exceed ₹10,00,000 (10 lakhs)
                        </mat-error>
                        }
                    </mat-form-field>

                    <!-- Tenure -->
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Tenure (Months)</mat-label>
                        <mat-icon matPrefix>schedule</mat-icon>
                        <input matInput type="number" formControlName="requestedTenureInMonths"
                            placeholder="Enter tenure" min="1" (keydown)="onTenureKeyDown($event)">
                        <mat-hint>Enter whole numbers only</mat-hint>

                        @if (requestedTenureInMonths?.hasError('required')) {
                        <mat-error>
                            Tenure is required
                        </mat-error>
                        }
                        @if (requestedTenureInMonths?.hasError('min')) {
                        <mat-error>
                            Tenure must be at least 1 month
                        </mat-error>
                        }
                        @if (requestedTenureInMonths?.hasError('max')) {
                        <mat-error>
                            Tenure cannot exceed {{ selectedLoanType()?.maxTenureInMonths }} months
                        </mat-error>
                        }
                        @if (requestedTenureInMonths?.hasError('notInteger')) {
                        <mat-error>
                            Tenure must be a whole number (no decimals)
                        </mat-error>
                        }
                    </mat-form-field>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Error Message -->
        @if (errorMessage()) {
        <mat-card class="error-message">
            <mat-card-content>
                <mat-icon color="warn">error</mat-icon>
                <span>{{ errorMessage() }}</span>
            </mat-card-content>
        </mat-card>
        }

        <!-- Preview EMI Button -->
        <div class="form-actions">
            <button mat-raised-button color="primary" type="button"
                [disabled]="applicationForm.invalid || isLoadingEmiPlan()" (click)="onPreviewEmi()" class="preview-btn">
                @if (isLoadingEmiPlan()) {
                <mat-spinner diameter="20"></mat-spinner>
                <span>Generating EMI Plan...</span>
                } @else {
                <span>Preview EMI Plan</span>
                }
            </button>
        </div>

        <!-- EMI Plan Preview -->
        @if (emiPlan().length > 0) {
        <app-emi-plan-preview [emiPlan]="emiPlan()" [loanType]="selectedLoanType()!"
            [requestedAmount]="requestedAmount?.value || 0" [tenure]="requestedTenureInMonths?.value || 0">
        </app-emi-plan-preview>

        <!-- Submit Button -->
        <div class="form-actions submit-section">
            <button mat-stroked-button type="button" (click)="resetForm()" class="reset-btn">
                <mat-icon>refresh</mat-icon>
                <span>Reset</span>
            </button>
            <button mat-raised-button color="primary" type="submit"
                [disabled]="applicationForm.invalid || isSubmitting()" class="submit-btn">
                @if (isSubmitting()) {
                <mat-spinner diameter="20"></mat-spinner>
                <span>Submitting...</span>
                } @else {
                <span>Submit Application</span>
                }
            </button>
        </div>
        }
    </form>
    }
    }
</div>