<h2 mat-dialog-title>
    <mat-icon>account_balance</mat-icon>
    Loan Details
</h2>

<mat-dialog-content>
    @if (isLoading()) {
    <div class="loading-state">
        <mat-spinner diameter="48"></mat-spinner>
        <p>Loading loan details...</p>
    </div>
    } @else if (errorMessage() && !loanDetails()) {
    <div class="error-message">
        <mat-icon color="warn">error_outline</mat-icon>
        <p>{{ errorMessage() }}</p>
    </div>
    } @else if (loanDetails()) {
    <div class="details-content">
        <!-- Loan Information Section -->
        <div class="loan-info-section">
            <h3>
                <mat-icon>info</mat-icon>
                Loan Information
            </h3>
            <div class="details-grid">
                <div class="detail-item">
                    <mat-icon class="detail-icon">confirmation_number</mat-icon>
                    <div class="detail-content">
                        <span class="label">Loan Number</span>
                        <span class="value">{{ loanDetails()!.loanNumber }}</span>
                    </div>
                </div>

                <div class="detail-item">
                    <mat-icon class="detail-icon">category</mat-icon>
                    <div class="detail-content">
                        <span class="label">Loan Type</span>
                        <span class="value">{{ loanDetails()!.loanType }}</span>
                    </div>
                </div>

                <div class="detail-item">
                    <mat-icon class="detail-icon">currency_rupee</mat-icon>
                    <div class="detail-content">
                        <span class="label">Approved Amount</span>
                        <span class="value">₹{{ loanDetails()!.approvedAmount | number:'1.2-2' }}</span>
                    </div>
                </div>

                <div class="detail-item">
                    <mat-icon class="detail-icon">account_balance_wallet</mat-icon>
                    <div class="detail-content">
                        <span class="label">Principal Remaining</span>
                        <span class="value">₹{{ loanDetails()!.principalRemaining | number:'1.2-2' }}</span>
                    </div>
                </div>

                <div class="detail-item">
                    <mat-icon class="detail-icon">schedule</mat-icon>
                    <div class="detail-content">
                        <span class="label">Tenure</span>
                        <span class="value">{{ loanDetails()!.tenureInMonths }} months</span>
                    </div>
                </div>

                <div class="detail-item">
                    <mat-icon class="detail-icon">percent</mat-icon>
                    <div class="detail-content">
                        <span class="label">Interest Rate</span>
                        <span class="value">{{ loanDetails()!.interestRate }}%</span>
                    </div>
                </div>

                <div class="detail-item">
                    <mat-icon class="detail-icon">check_circle</mat-icon>
                    <div class="detail-content">
                        <span class="label">Status</span>
                        <mat-chip highlighted>{{ loanDetails()!.status }}</mat-chip>
                    </div>
                </div>
            </div>
        </div>

        <!-- EMI Payments Section -->
        <div class="emis-section">
            <h3>
                <mat-icon>payment</mat-icon>
                EMI Payments
            </h3>

            <mat-tab-group
                (selectedIndexChange)="onEmiStatusChange($event === 0 ? EmiDueStatus.Overdue : EmiDueStatus.Upcoming)">
                <mat-tab label="Overdue">
                    @if (emis().length === 0) {
                    <div class="empty-emis">
                        <mat-icon>check_circle_outline</mat-icon>
                        <p>No overdue EMIs</p>
                    </div>
                    } @else {
                    <div class="emis-list">
                        @for (emi of emis(); track emi.dueDate) {
                        <div class="emi-item" [class.selected]="selectedEmi() === emi" (click)="onSelectEmi(emi)">
                            <div class="emi-header">
                                <span class="due-date">
                                    <mat-icon>event</mat-icon>
                                    {{ emi.dueDate | date:'mediumDate' }}
                                </span>
                                <span class="total-amount">₹{{ getTotalDue(emi) | number:'1.2-2' }}</span>
                            </div>
                            <div class="emi-breakdown">
                                <div class="breakdown-item">
                                    <span>Principal:</span>
                                    <span>₹{{ emi.principalComponent | number:'1.2-2' }}</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>Interest:</span>
                                    <span>₹{{ emi.interestComponent | number:'1.2-2' }}</span>
                                </div>
                                @if (emi.penaltyAmount > 0) {
                                <div class="breakdown-item penalty">
                                    <span>Penalty:</span>
                                    <span>₹{{ emi.penaltyAmount | number:'1.2-2' }}</span>
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </div>
                    }
                </mat-tab>
                <mat-tab label="Upcoming">
                    @if (emis().length === 0) {
                    <div class="empty-emis">
                        <mat-icon>check_circle_outline</mat-icon>
                        <p>No upcoming EMIs</p>
                    </div>
                    } @else {
                    <div class="emis-list">
                        @for (emi of emis(); track emi.dueDate) {
                        <div class="emi-item" [class.selected]="selectedEmi() === emi" (click)="onSelectEmi(emi)">
                            <div class="emi-header">
                                <span class="due-date">
                                    <mat-icon>event</mat-icon>
                                    {{ emi.dueDate | date:'mediumDate' }}
                                </span>
                                <span class="total-amount">₹{{ getTotalDue(emi) | number:'1.2-2' }}</span>
                            </div>
                            <div class="emi-breakdown">
                                <div class="breakdown-item">
                                    <span>Principal:</span>
                                    <span>₹{{ emi.principalComponent | number:'1.2-2' }}</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>Interest:</span>
                                    <span>₹{{ emi.interestComponent | number:'1.2-2' }}</span>
                                </div>
                            </div>
                        </div>
                        }
                    </div>
                    }
                </mat-tab>
            </mat-tab-group>

            <!-- Payment Form -->
            @if (selectedEmi()) {
            <div class="payment-form">
                <h4>Make Payment</h4>

                @if (successMessage()) {
                <div class="success-message">
                    <mat-icon>check_circle</mat-icon>
                    {{ successMessage() }}
                </div>
                }
                @if (errorMessage()) {
                <div class="error-message">
                    <mat-icon>error</mat-icon>
                    {{ errorMessage() }}
                </div>
                }

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Payment Amount</mat-label>
                    <input matInput type="number" [formControl]="paymentAmount"
                        (keydown)="onPaymentAmountKeyDown($event)" min="0" step="0.01">
                    <span matPrefix>₹&nbsp;</span>

                    @if (paymentAmount.hasError('required')) {
                    <mat-error>
                        Payment amount is required
                    </mat-error>
                    }
                    @if (paymentAmount.hasError('min')) {
                    <mat-error>
                        Payment amount must be greater than zero
                    </mat-error>
                    }
                    @if (paymentAmount.hasError('max')) {
                    <mat-error>
                        Payment amount cannot exceed ₹1,000 trillion
                    </mat-error>
                    }
                    @if (paymentAmount.hasError('decimalPlaces')) {
                    <mat-error>
                        Payment amount can have maximum 2 decimal places
                    </mat-error>
                    }
                </mat-form-field>

                <button mat-raised-button color="primary" [disabled]="isProcessingPayment() || paymentAmount.invalid"
                    (click)="onMakePayment()" class="full-width">
                    @if (isProcessingPayment()) {
                    <mat-spinner diameter="20"></mat-spinner>
                    <span>Processing...</span>
                    } @else {
                    <span>Pay ₹{{ paymentAmount.value | number:'1.2-2' }}</span>
                    }
                </button>
            </div>
            }
        </div>

        <!-- Payment History Section -->
        <div class="payment-history-section">
            <h3>
                <mat-icon>history</mat-icon>
                Payment History
            </h3>

            @if (isLoadingHistory()) {
            <div class="loading-state">
                <mat-spinner diameter="32"></mat-spinner>
                <p>Loading payment history...</p>
            </div>
            } @else if (paymentHistory().length === 0) {
            <div class="empty-history">
                <mat-icon>inbox</mat-icon>
                <p>No payment history available</p>
            </div>
            } @else {
            <table mat-table [dataSource]="paymentHistory()" class="payment-history-table">
                <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef>Date</th>
                    <td mat-cell *matCellDef="let payment">{{ payment.paymentDate | date:'medium' }}</td>
                </ng-container>

                <ng-container matColumnDef="amount">
                    <th mat-header-cell *matHeaderCellDef>Amount</th>
                    <td mat-cell *matCellDef="let payment">₹{{ payment.amount | number:'1.2-2' }}</td>
                </ng-container>

                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let payment">
                        <mat-chip [color]="payment.status === 'Paid' ? 'accent' : 'primary'" highlighted>
                            {{ payment.status }}
                        </mat-chip>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
            }
        </div>
    </div>
    }
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button (click)="onClose()">Close</button>
</mat-dialog-actions>